---
title: "BR02 20/11/2024"
output: word_document
date: "2024-12-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyr)
library(purrr)
library(dplyr)
library(stringr)
library(data.table)
library(readr)
library(writexl)
library(stringr)
library(ggplot2)
library(caret)

long_df <- read.csv("C:/Users/rocpa/OneDrive/Documenti/GitHub/tragedynatural/data_analysis/df_simulations.csv",sep=",")

# long_df <- long_df %>% filter(long_df$turn != "BR02")

# BR02_corrected <- read.csv("C:/Users/rocpa/OneDrive/Documenti/GitHub/tragedynatural/Roma_BR/BR02/BR02_simulations_corrected.csv",sep = ";")
# 
# long_df <- rbind(long_df, BR02_corrected)


long_df[long_df$output == "capital",]$output <- "Capitale totale"
long_df[long_df$output == "ccr",]$output <- "Contributo comune"
long_df[long_df$output == "daysurvived",]$output <- "Giorni in vita farmers"
long_df[long_df$output == "energiaaquisita",]$output <- "Energia acquisita"
long_df[long_df$output == "giornaliero",]$output <- "Guadagno giornaliero"
long_df[long_df$output == "mucche",]$output <- "Mucche in vita"
long_df[long_df$output == "muccheperse",]$output <- "Mucche perse"
long_df[long_df$output == "muccheslider",]$output <- "Mucche acquisite"
long_df[long_df$output == "giorno",]$output <- "Giorno"
long_df[long_df$output == "risenergtot",]$output <- "Risorse ambientali"
long_df[long_df$condition == "pre",]$condition <- "Prima simulazione"
long_df[long_df$condition == "post",]$condition <- "Seconda simulazione"

# long_dfnor <- long_df %>% filter(!is.na(score)) %>% group_by(turn, output, condition)%>% mutate(xnorm = (score - min(score)) / (max(score) - min(score)), na.rm=T) %>%  ungroup() 

# replace(is.na(.), 0) %>%
# long_dfnorm1 <- long_df %>% filter(condition == "Prima simulazione") %>% group_by(turn, output, condition)%>% mutate(xnorm = (score - min(score)) / (max(score) - min(score))) %>%  ungroup() 
# long_dfnorm2 <- long_df %>% filter(condition == "Seconda simulazione") %>% group_by(turn, output, condition)%>% mutate(xnorm = (score - min(score)) / (max(score) - min(score))) %>%  ungroup() 
# 
# long_dfnor <- rbind(long_dfnorm1,long_dfnorm2)

long_df$week <- 0
long_df[long_df$time %in% c(1:7),]$week <- 1
long_df[long_df$time %in% c(8:14),]$week <- 2
long_df[long_df$time %in% c(15:21),]$week <- 3
long_df[long_df$time %in% c(22:28),]$week <- 4
long_df[long_df$time %in% c(29:35),]$week <- 5

long_df$weekday <-0
long_df[long_df$time %in% c(1,8,15,22,29),]$weekday <- 1
long_df[long_df$time %in% c(2,9,16,23,30),]$weekday <- 2
long_df[long_df$time %in% c(3,10,17,24,31),]$weekday <- 3
long_df[long_df$time %in% c(4,11,18,25,32),]$weekday <- 4
long_df[long_df$time %in% c(5,12,19,26,33),]$weekday <- 5
long_df[long_df$time %in% c(6,13,20,27,34),]$weekday <- 6
long_df[long_df$time %in% c(7,14,21,28,35),]$weekday <- 7

```

```{r coop, echo=FALSE, include = FALSE}

# link reverse bars

data_wide <- spread(long_df, output, score) %>% replace(is.na(.), 0) %>% filter(turn %in% c("BR01","BR02","BR03","BR04","BR05")) %>% filter(color != 0) %>% filter(time %in% c(0,1,7,8,14,15,21,22,28,29,35))

datawide_ccrtot <- data_wide %>% group_by(turn,time,condition,note) %>% summarise(ccrtot = sum(ccr))
datawide_nrgtot <- data_wide %>% group_by(turn,time,condition,note) %>% summarise(nrgtot = sum(energiaaquisita))

df <- merge(data_wide, datawide_ccrtot, by = c("turn","time","condition","note"))
df <- merge(df, datawide_nrgtot, by = c("turn","time","condition","note"))

df$propccr <- df$ccr / df$ccrtot
df$propnrg <- df$energiaaquisita / df$nrgtot

dfpropcr <- df %>% filter(weekday == 1) %>% select(turn,color,week,condition, propccr)
dfpropng <- df %>% filter(weekday == 7) %>% select(turn,color,week,condition, propnrg)

dffin <- merge(dfpropcr, dfpropng, by = c("turn","color","condition","week")) %>% replace(is.na(.), 0)
dffin <- dffin %>% mutate(propdiff = (propccr - propnrg))
dffin <- dffin %>% mutate(propfract = (propccr / propnrg))



dffinlong <- dffin %>%  pivot_longer(cols = c(5,6), names_to = c("variable"), values_to = "score") 


# dffinlong %>% 
#   ggplot(aes(fill=color, y=score, x=variable)) + 
#     geom_bar(position="stack", stat="identity") + 
#   scale_fill_manual(values = c("rosso" = "red","blu" = "blue","azzurro" = "cyan","giallo" = "orange","rosa" = "pink"))
# 
# dffin %>%  filter(turn == "BR05" & condition == "post") %>% ggplot(aes(x = week, y = propfract)) +
#   geom_line(aes(color = color)) +
#    scale_color_manual(values = c("rosso" = "red","blu" = "blue","azzurro" = "cyan","giallo" = "orange","rosa" = "pink")) +
#   theme_bw()
# 
# 
# dffinlong %>% filter(turn == "BR05" & condition == "post" & variable == "propnrg") %>%
#   ggplot(aes(y=score, x=week, fill = color)) + 
#     geom_bar(position="stack", stat="identity") + 
#   scale_fill_manual(values = c("rosso" = "red","blu" = "blue","azzurro" = "cyan","giallo" = "orange","rosa" = "pink")) + 
#   theme_bw()

dffinlong[dffinlong$condition == "pre",]$condition <- "First Simulation"
dffinlong[dffinlong$condition == "post",]$condition <- "Second Simulation"

dffinlong %>% 
  ggplot(aes(y=score, x=week)) + 
  geom_line(aes(linetype = variable, color = color)) + 
  geom_point(aes(color = color, shape = variable), size = 2) +
   scale_color_manual(values = c("rosso" = "red","blu" = "blue","azzurro" = "cyan","giallo" = "orange","rosa" = "pink"), name = "group") + 
   scale_shape_manual(values = c("propccr" = "square", "propnrg" = "triangle"),
                      name = "indicator", labels = c("% energy renewal", "% energy consumption")
                      ) + 
   scale_linetype_manual(values = c("propccr" = "solid","propnrg" = "longdash"),guide = "none") +
  facet_wrap(~ turn + factor(condition,c("First Simulation","Second Simulation")),
             scales = "free_y", ncol = 2) + 
  theme_bw() +
  guides(shape = guide_legend(position =  "bottom", nrow = 2)) + 
  guides(color = guide_legend(position = "bottom"))
ggsave(file= "propcoop.png",width = 8, height = 11)


```




## Explorative by groups

Corrected BR02, gruppo rosso, seconda simulazione, day 27, 28, Mucche Acquistite 50 -> 11
Corrected BR02, gruppo azzurro, seconda simulazione, day 33, 34, 35 , Mucche Acquisite 16 -> 14
Corrected BR02, gruppo blu, seconda simulazione, day 35, CCR 520 -> 260


```{r read_data1, echo=FALSE, include = TRUE}

variables <- c("Capitale totale","Guadagno giornaliero","Contributo comune","Mucche acquisite", "Mucche in vita","Mucche perse","Energia acquisita","Risorse ambientali","Giorni in vita farmers","Giorno")

long_df <- long_df %>% filter(turn %in% c("BR02"))

for (i in variables){

plot_i <- long_df[long_df$output == i,] %>% ggplot(aes(x = time, y = score)) + geom_line(aes(color = color)) +
  scale_color_manual("gruppo", values=c(azzurro="cyan", blu="blue", rosso = "red",giallo = "yellow",rosa = "pink")) +
  scale_x_continuous(breaks=seq(0,35,7)) +
facet_grid(turn ~ factor(condition, levels = c("Prima simulazione","Seconda simulazione")), scales = "free_y") +
  labs(title = i, x = "giorni", y = i) +
  theme_bw( ) +
  theme(
    axis.text.x = element_text(angle = 45),legend.position = "bottom")

plot(plot_i)

}
```


<!-- ```{r read_data, echo=FALSE, fig.width=9, fig.height=7} -->

<!-- variables <- c("Contributo comune","Mucche acquisite","Capitale totale", -->
<!--          "Mucche perse","Energia acquisita") -->

<!-- long_df <- long_df %>% filter(turn %in% c("GE03","GE04","BR01","BR02","BR03") & condition == "Prima simulazione" & time >= 8) -->


<!-- plot_i <- long_df %>%  filter(output %in% variables) %>% ggplot(aes(x = time, y = score)) + geom_line(aes(color = color)) + -->
<!--   scale_color_manual("gruppo", values=c(azzurro="cyan", blu="blue", rosso = "red",giallo = "yellow",rosa = "pink")) + -->
<!--   scale_x_continuous(breaks=seq(8,36,7)) + -->
<!-- facet_wrap(turn ~ factor(output,levels = c("Contributo comune","Mucche acquisite","Capitale totale", "Mucche perse","Energia acquisita")) , scales = "free_y", ncol = 5) + -->
<!--   ggtitle(long_df$condition) + -->
<!--   labs(x = "giorni", y = "") + -->
<!--   theme_bw( ) + -->
<!--   theme(axis.text.x = element_text(angle = 45),legend.position = "bottom") -->

<!-- plot(plot_i) -->


<!-- ``` -->