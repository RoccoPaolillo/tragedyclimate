---
title: "BR02 20/11/2024"
output: word_document
date: "2024-12-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyr)
library(purrr)
library(dplyr)
library(stringr)
library(data.table)
library(readr)
library(writexl)
library(stringr)
library(ggplot2)
library(caret)

long_df <- read.csv("C:/Users/rocpa/OneDrive/Documenti/GitHub/tragedynatural/data_analysis/df_simulations.csv",sep=",")

data_wide <- spread(long_df, output, score) %>% replace(is.na(.), 0) %>% filter(turn %in% c("BR01","BR02","BR03","BR04","BR05")) %>% filter(color != 0) %>% filter(time %in% c(0,1,7,8,14,15,21,22,28,29,35))


long_df[long_df$output == "capital",]$output <- "Capitale totale"
long_df[long_df$output == "ccr",]$output <- "Contributo comune"
long_df[long_df$output == "daysurvived",]$output <- "Giorni in vita farmers"
long_df[long_df$output == "energiaaquisita",]$output <- "Energia acquisita"
long_df[long_df$output == "giornaliero",]$output <- "Guadagno giornaliero"
long_df[long_df$output == "mucche",]$output <- "Mucche in vita"
long_df[long_df$output == "muccheperse",]$output <- "Mucche perse"
long_df[long_df$output == "muccheslider",]$output <- "Mucche acquisite"
long_df[long_df$output == "giorno",]$output <- "Giorno"
long_df[long_df$output == "risenergtot",]$output <- "Risorse ambientali"
long_df[long_df$condition == "pre",]$condition <- "Prima simulazione"
long_df[long_df$condition == "post",]$condition <- "Seconda simulazione"

```

```{r coop, echo=FALSE, include = FALSE}

datawide_ccrtot <- data_wide %>% group_by(turn,time,condition,note) %>% summarise(ccrtot = sum(ccr))
datawide_nrgtot <- data_wide %>% group_by(turn,time,condition,note) %>% summarise(nrgtot = sum(energiaaquisita))

df <- merge(data_wide, datawide_ccrtot, by = c("turn","time","condition","note"))
df <- merge(df, datawide_nrgtot, by = c("turn","time","condition","note"))

df$propccr <- df$ccr / df$ccrtot
df$propnrg <- df$energiaaquisita / df$nrgtot

dfpropcr <- df %>% filter(weekday == 1) %>% select(turn,color,week,condition, propccr)
dfpropng <- df %>% filter(weekday == 7) %>% select(turn,color,week,condition, propnrg)

dffin <- merge(dfpropcr, dfpropng, by = c("turn","color","condition","week")) %>% replace(is.na(.), 0)
dffin <- dffin %>% mutate(propdiff = (propccr - propnrg))
dffin <- dffin %>% mutate(propfract = (propccr / propnrg))

dffinlong <- dffin %>%  pivot_longer(cols = c(5,6), names_to = c("variable"), values_to = "score") 

dffinlong[dffinlong$condition == "pre",]$condition <- "First Simulation"
dffinlong[dffinlong$condition == "post",]$condition <- "Second Simulation"

dffinlong %>% 
  ggplot(aes(y=score, x=week)) + 
  geom_line(aes(linetype = variable, color = color)) + 
  geom_point(aes(color = color, shape = variable), size = 2) +
   scale_color_manual(values = c("rosso" = "red","blu" = "blue","azzurro" = "cyan","giallo" = "orange","rosa" = "pink"), name = "group") + 
   scale_shape_manual(values = c("propccr" = "square", "propnrg" = "triangle"),
                      name = "indicator", labels = c("% energy renewal", "% energy consumption")
                      ) + 
   scale_linetype_manual(values = c("propccr" = "solid","propnrg" = "longdash"),guide = "none") +
  facet_wrap(~ turn + factor(condition,c("First Simulation","Second Simulation")),
             scales = "free_y", ncol = 2) + 
  theme_bw() +
  guides(shape = guide_legend(position =  "bottom", nrow = 2)) + 
  guides(color = guide_legend(position = "bottom"))
ggsave(file= "propcoop.png",width = 8, height = 11)


```


```{r capital_proportion, echo=FALSE, include = FALSE}

dftfirst <- data_wide  %>% filter(time %in% c(8,15,22,29)) %>% select(turn,color, condition, time,week,weekday, mucche, muccheslider, muccheperse, capital, ccr)
dftlast <- data_wide %>% filter(time %in% c(7,14,21,28,35)) %>% select(turn,color, condition, time,week,weekday, mucche, muccheslider, muccheperse, capital, ccr)


dft8 <- merge(dftfirst,dftlast,by=c("turn","color", "condition"))

dft9 <- dft8 %>% filter(time.x == 8 & time.y == 7| time.x == 15 & time.y == 14 | time.x == 22 & time.y == 21|
                          time.x ==29 & time.y == 28)

dft9$mucchenew <- ifelse(dft9$muccheslider.x > dft9$mucche.y, dft9$muccheslider.x - dft9$mucche.y,dft9$muccheslider.x)
dft9$mucchenewcost <- dft9$mucchenew * 10
dft9$mucchemngcost <- dft9$muccheslider.x * 70
dft9$mucchetotalcost <- dft9$mucchenewcost + dft9$mucchemngcost
dft9$propbuycow <- dft9$mucchenewcost / dft9$capital.y
dft9$propinvccr <- dft9$ccr.x / dft9$capital.y 
dft9$totcosts <- (dft9$mucchenewcost + dft9$ccr.x)
dft9$propsaving <- (dft9$capital.y - dft9$totcosts) / dft9$capital.y
dft9$totinvest <- dft9$propbuycow + dft9$propinvccr + dft9$propsaving


long_dft9 <- dft9 %>%  pivot_longer(cols = c(24,25,27), names_to = c("variable"), values_to = "score")  %>% replace(is.na(.), 0)

long_dft9[long_dft9$condition == "pre",]$condition <- "First Simulation"
long_dft9[long_dft9$condition == "post",]$condition <- "Second Simulation"

long_dft9 %>% 
ggplot(aes(x = week.x, y = score, color = color)) + 
geom_line(aes(linetype = variable, color = color)) +
  geom_point(aes(shape = variable, color = color), size = 2) +
  scale_color_manual(values = c("rosso" = "red","blu" = "blue","azzurro" = "cyan","giallo" = "orange","rosa" = "pink"), name = "group") + 
  scale_shape_manual(values = c("propbuycow" = "triangle", "propsaving" = "square", "propsaving" = "circle"),
                      name = "indicator", labels = c("new cows", "energy renewal","saving")
                      ) + 
  scale_linetype_manual(values = c("propbuycow" = "solid", "propsaving" = "dotted", "propsaving" = "dashed"),
                      name = "indicator", labels = c("new cows", "energy renewal","saving")
                      
                      ) + 
facet_wrap(~ turn + factor(condition,c("First Simulation","Second Simulation")),
             scales = "free_y", ncol = 2) + 
  theme_bw() +
  guides(shape = guide_legend(position =  "bottom")) + 
  guides(color = guide_legend(position = "bottom")) +
  guides(linetype = "none")
ggsave(file= "propinvestments.png",width = 8, height = 11)


```


## Explorative by groups

Corrected BR02, gruppo rosso, seconda simulazione, day 27, 28, Mucche Acquistite 50 -> 11
Corrected BR02, gruppo azzurro, seconda simulazione, day 33, 34, 35 , Mucche Acquisite 16 -> 14
Corrected BR02, gruppo blu, seconda simulazione, day 35, CCR 520 -> 260


```{r read_data1, echo=FALSE, include = TRUE}

variables <- c("Capitale totale","Guadagno giornaliero","Contributo comune","Mucche acquisite", "Mucche in vita","Mucche perse","Energia acquisita","Risorse ambientali","Giorni in vita farmers","Giorno")

long_df <- long_df %>% filter(turn %in% c("BR02"))

for (i in variables){

plot_i <- long_df[long_df$output == i,] %>% ggplot(aes(x = time, y = score)) + geom_line(aes(color = color)) +
  scale_color_manual("gruppo", values=c(azzurro="cyan", blu="blue", rosso = "red",giallo = "yellow",rosa = "pink")) +
  scale_x_continuous(breaks=seq(0,35,7)) +
facet_grid(turn ~ factor(condition, levels = c("Prima simulazione","Seconda simulazione")), scales = "free_y") +
  labs(title = i, x = "giorni", y = i) +
  theme_bw( ) +
  theme(
    axis.text.x = element_text(angle = 45),legend.position = "bottom")

plot(plot_i)

}
```


<!-- ```{r read_data, echo=FALSE, fig.width=9, fig.height=7} -->

<!-- variables <- c("Contributo comune","Mucche acquisite","Capitale totale", -->
<!--          "Mucche perse","Energia acquisita") -->

<!-- long_df <- long_df %>% filter(turn %in% c("GE03","GE04","BR01","BR02","BR03") & condition == "Prima simulazione" & time >= 8) -->


<!-- plot_i <- long_df %>%  filter(output %in% variables) %>% ggplot(aes(x = time, y = score)) + geom_line(aes(color = color)) + -->
<!--   scale_color_manual("gruppo", values=c(azzurro="cyan", blu="blue", rosso = "red",giallo = "yellow",rosa = "pink")) + -->
<!--   scale_x_continuous(breaks=seq(8,36,7)) + -->
<!-- facet_wrap(turn ~ factor(output,levels = c("Contributo comune","Mucche acquisite","Capitale totale", "Mucche perse","Energia acquisita")) , scales = "free_y", ncol = 5) + -->
<!--   ggtitle(long_df$condition) + -->
<!--   labs(x = "giorni", y = "") + -->
<!--   theme_bw( ) + -->
<!--   theme(axis.text.x = element_text(angle = 45),legend.position = "bottom") -->

<!-- plot(plot_i) -->


<!-- ``` -->